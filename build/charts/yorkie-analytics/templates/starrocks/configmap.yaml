{{- if index .Values "yorkie-analytics" "starrocks" "enabled" }}
apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ .Values.name }}-init-starrocks-database-script
  namespace: {{ .Values.namespace }}
  labels:
    app.kubernetes.io/component: starrocks
    app.kubernetes.io/part-of: yorkie-analytics
data:
  init-create-table.sql: |
    CREATE DATABASE IF NOT EXISTS yorkie;

    USE yorkie;

    CREATE TABLE IF NOT EXISTS user_events (
        user_id VARCHAR(64),
        timestamp DATETIME, 
        event_type VARCHAR(32),
        project_id VARCHAR(64),
        user_agent VARCHAR(32)
    ) ENGINE = OLAP  
    DUPLICATE KEY(user_id)  
    DISTRIBUTED BY HASH(user_id) BUCKETS 10
    PROPERTIES (  
        "replication_num" = "1"
    );

    CREATE TABLE IF NOT EXISTS document_events (
        project_id VARCHAR(64),
        document_key VARCHAR(128),
        actor_id VARCHAR(64),
        timestamp DATETIME,
        event_type VARCHAR(32)
    ) ENGINE = OLAP  
    DUPLICATE KEY(project_id, document_key, actor_id, timestamp)  
    DISTRIBUTED BY HASH(project_id) BUCKETS 16  
    PROPERTIES (  
        "replication_num" = "1"  
    );  

    CREATE TABLE IF NOT EXISTS channel_events (
        project_id VARCHAR(64),
        channel_key VARCHAR(128),
        timestamp DATETIME,
        event_type VARCHAR(32)
    ) ENGINE = OLAP
    DUPLICATE KEY(project_id, channel_key, timestamp)
    DISTRIBUTED BY HASH(project_id) BUCKETS 16
    PROPERTIES (
        "replication_num" = "1"
    );

    CREATE TABLE IF NOT EXISTS session_events (
        project_id VARCHAR(64),
        session_id VARCHAR(64),
        timestamp DATETIME,
        user_id VARCHAR(64),
        channel_key VARCHAR(128),
        event_type VARCHAR(32)
    ) ENGINE = OLAP
    DUPLICATE KEY(project_id, session_id, timestamp)
    DISTRIBUTED BY HASH(project_id) BUCKETS 16
    PROPERTIES (
        "replication_num" = "1"
    );

    CREATE TABLE IF NOT EXISTS client_events (
        project_id VARCHAR(64),
        client_id VARCHAR(64),
        timestamp DATETIME,
        event_type VARCHAR(32)
    ) ENGINE = OLAP
    DUPLICATE KEY(project_id, client_id, timestamp)
    DISTRIBUTED BY HASH(project_id) BUCKETS 16
    PROPERTIES (
        "replication_num" = "1"
    );


  init-create-routine-load.sql: |
    CREATE ROUTINE LOAD yorkie.user_events ON user_events
    PROPERTIES
    (
        "format" = "JSON",
        "desired_concurrent_number"="1"
    )
    FROM KAFKA
    (   
        "kafka_broker_list" = "{{ index .Values "yorkie-analytics" "starrocks" "routine-load" "kafka-broker-list" }}",
        "kafka_topic" = "{{ index .Values "yorkie-analytics" "starrocks" "routine-load" "kafka-user-events" "topic" }}",
        "property.group.id" = "{{ index .Values "yorkie-analytics" "starrocks" "routine-load" "kafka-user-events" "property-group-id" }}"
    );

    CREATE ROUTINE LOAD yorkie.document_events ON document_events
    PROPERTIES
    (
        "format" = "JSON",
        "desired_concurrent_number"="1"
    )
    FROM KAFKA
    (   
        "kafka_broker_list" = "{{ index .Values "yorkie-analytics" "starrocks" "routine-load" "kafka-broker-list" }}",
        "kafka_topic" = "{{ index .Values "yorkie-analytics" "starrocks" "routine-load" "kafka-document-events" "topic" }}",
        "property.group.id" = "{{ index .Values "yorkie-analytics" "starrocks" "routine-load" "kafka-document-events" "property-group-id" }}"
    );

    CREATE ROUTINE LOAD yorkie.channel_events ON channel_events
    PROPERTIES
    (
        "format" = "JSON",
        "desired_concurrent_number"="1"
    )
    FROM KAFKA
    (
        "kafka_broker_list" = "{{ index .Values "yorkie-analytics" "starrocks" "routine-load" "kafka-broker-list" }}",
        "kafka_topic" = "{{ index .Values "yorkie-analytics" "starrocks" "routine-load" "kafka-channel-events" "topic" }}",
        "property.group.id" = "{{ index .Values "yorkie-analytics" "starrocks" "routine-load" "kafka-channel-events" "property-group-id" }}"
    );

    CREATE ROUTINE LOAD yorkie.session_events ON session_events
    PROPERTIES
    (
        "format" = "JSON",
        "desired_concurrent_number"="1"
    )
    FROM KAFKA
    (
        "kafka_broker_list" = "{{ index .Values "yorkie-analytics" "starrocks" "routine-load" "kafka-broker-list" }}",
        "kafka_topic" = "{{ index .Values "yorkie-analytics" "starrocks" "routine-load" "kafka-session-events" "topic" }}",
        "property.group.id" = "{{ index .Values "yorkie-analytics" "starrocks" "routine-load" "kafka-session-events" "property-group-id" }}"
    );

    CREATE ROUTINE LOAD yorkie.client_events ON client_events
    PROPERTIES
    (
        "format" = "JSON",
        "desired_concurrent_number"="1"
    )
    FROM KAFKA
    (
        "kafka_broker_list" = "{{ index .Values "yorkie-analytics" "starrocks" "routine-load" "kafka-broker-list" }}",
        "kafka_topic" = "{{ index .Values "yorkie-analytics" "starrocks" "routine-load" "kafka-client-events" "topic" }}",
        "property.group.id" = "{{ index .Values "yorkie-analytics" "starrocks" "routine-load" "kafka-client-events" "property-group-id" }}"
    );

  init-starrocks-database.sh: |
    #!/bin/bash

    STARROCKS_MYSQL_HOST=kube-starrocks-fe-service.{{ .Values.namespace }}.svc.cluster.local
    
    sleep 5s
    echo -e 'Checking Starrocks status'
    mysql -h $STARROCKS_MYSQL_HOST -P 9030 -u root -e 'show frontends\G' | grep 'Alive: true' || echo -e 'Frontend is not ready'
    mysql -h $STARROCKS_MYSQL_HOST -P 9030 -u root -e 'show backends\G' | grep 'Alive: true' || echo -e 'Starrocks BE is not ready'


    echo -e 'Creating Yorkie database, tables and routine load'
    mysql -h $STARROCKS_MYSQL_HOST -P 9030 -u root < /etc/config/init-create-table.sql

    echo -e 'Checking Yorkie database'
    mysql -h $STARROCKS_MYSQL_HOST -P 9030 -u root -e 'show databases\G'
    mysql -h $STARROCKS_MYSQL_HOST -P 9030 -u root -e 'show databases\G' | grep 'Database: yorkie' || echo -e 'Yorkie database not found'

    echo -e 'Checking user_event table'
    mysql -h $STARROCKS_MYSQL_HOST -P 9030 -u root -e 'show tables from yorkie\G'
    mysql -h $STARROCKS_MYSQL_HOST -P 9030 -u root -e 'show tables from yorkie\G' | grep 'Tables_in_yorkie: user_events' || echo -e 'user_events table not found'
    mysql -h $STARROCKS_MYSQL_HOST -P 9030 -u root -e 'show tables from yorkie\G' | grep 'Tables_in_yorkie: document_events' || echo -e 'document_events table not found'
    mysql -h $STARROCKS_MYSQL_HOST -P 9030 -u root -e 'show tables from yorkie\G' | grep 'Tables_in_yorkie: channel_events' || echo -e 'channel_events table not found'
    mysql -h $STARROCKS_MYSQL_HOST -P 9030 -u root -e 'show tables from yorkie\G' | grep 'Tables_in_yorkie: session_events' || echo -e 'session_events table not found'
    mysql -h $STARROCKS_MYSQL_HOST -P 9030 -u root -e 'show tables from yorkie\G' | grep 'Tables_in_yorkie: client_events' || echo -e 'client_events table not found'


    sleep 5s
    echo -e 'Creating routine load'
    if mysql -h $STARROCKS_MYSQL_HOST -P 9030 -u root < /etc/config/init-create-routine-load.sql 2>/dev/null; then
      echo -e 'Successfully created routine loads'
    else
      echo -e 'Routine loads may already exist, continuing...'
    fi

    sleep 10s
    echo -e 'Checking and resuming routine loads if needed'
    mysql -h $STARROCKS_MYSQL_HOST -P 9030 -u root -e 'show routine load from yorkie\G'

    routine_loads=(yorkie.user_events yorkie.document_events yorkie.channel_events yorkie.session_events yorkie.client_events)
    for routine_load in ${routine_loads[@]}; do
      state=$(mysql -h $STARROCKS_MYSQL_HOST -P 9030 -u root -e "show routine load for $routine_load\G" 2>/dev/null | grep State: | sed 's/.*State: //')
      echo "Routine load $routine_load state: $state"
      if [ "$state" = "PAUSED" ]; then
        echo "Resuming routine load: $routine_load"
        mysql -h $STARROCKS_MYSQL_HOST -P 9030 -u root -e "RESUME ROUTINE LOAD FOR $routine_load;"
      fi
    done

    echo -e 'Final routine load status:'
    mysql -h $STARROCKS_MYSQL_HOST -P 9030 -u root -e 'show routine load from yorkie\G'
{{- end }}
