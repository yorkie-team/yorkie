{{- if .Values.mongodb.enabled }}
{{- if .Values.mongodb.setup.enabled }}
apiVersion: batch/v1
kind: Job
metadata:
  name: mongodb-sharding-setup
  namespace: {{ .Values.yorkie.namespace }}
  labels:
    app.kubernetes.io/name: mongodb-sharding-setup
    app.kubernetes.io/instance: {{ .Release.Name }}
    app.kubernetes.io/managed-by: {{ .Release.Service }}
  annotations:
    "helm.sh/hook": post-install,post-upgrade
    "helm.sh/hook-weight": "10"
    "helm.sh/hook-delete-policy": before-hook-creation
spec:
  backoffLimit: {{ .Values.mongodb.setup.backoffLimit }}
  template:
    metadata:
      labels:
        app.kubernetes.io/name: mongodb-sharding-setup
        app.kubernetes.io/instance: {{ .Release.Name }}
    spec:
      restartPolicy: {{ .Values.mongodb.setup.restartPolicy }}
      serviceAccountName: yorkie-db-provisioning-job-account
      containers:
      - name: mongodb-sharding-setup
        image: percona/percona-server-mongodb:8.0.12-4
        command:
          - /bin/bash
          - -c
          - |
            set -e
            
            echo "Waiting for MongoDB to be ready..."
            until mongosh --host mongodb-mongos.{{ .Values.yorkie.namespace }}.svc.cluster.local:27017 \
                          --username "${MONGODB_USERNAME}" \
                          --password "${MONGODB_PASSWORD}" \
                          --authenticationDatabase admin \
                          --eval "db.adminCommand('ping')" > /dev/null 2>&1; do
              echo "MongoDB not ready yet, waiting..."
              sleep 5
            done
            
            echo "MongoDB is ready. Waiting for shards to be available..."
            
            # Wait for shards to be registered
            TIMEOUT=300  # 5 minutes
            ELAPSED=0
            while true; do
              SHARD_COUNT=$(mongosh --host mongodb-mongos.{{ .Values.yorkie.namespace }}.svc.cluster.local:27017 \
                            --username "${MONGODB_USERNAME}" \
                            --password "${MONGODB_PASSWORD}" \
                            --authenticationDatabase admin \
                            --quiet \
                            --eval "db.getSiblingDB('config').shards.countDocuments({ state: 1 })" 2>/dev/null || echo "0")
              
              if [ "$SHARD_COUNT" -gt "0" ]; then
                echo "Found $SHARD_COUNT active shard(s). Setting up sharding..."
                break
              fi
              
              if [ $ELAPSED -ge $TIMEOUT ]; then
                echo "Timeout waiting for shards to be registered"
                exit 1
              fi
              
              echo "Shards not ready yet, waiting... ($ELAPSED/$TIMEOUT seconds)"
              sleep 10
              ELAPSED=$((ELAPSED + 10))
            done
            
            # Enable sharding for the database
            mongosh --host mongodb-mongos.{{ .Values.yorkie.namespace }}.svc.cluster.local:27017 \
                    --username "${MONGODB_USERNAME}" \
                    --password "${MONGODB_PASSWORD}" \
                    --authenticationDatabase admin \
                    --eval "sh.enableSharding('{{ .Values.mongodb.setup.database }}')"
            
            {{- range .Values.mongodb.setup.rules }}
            # Shard collection: {{ .collectionName }}
            echo "Sharding collection {{ .collectionName }}..."
            mongosh --host mongodb-mongos.{{ $.Values.yorkie.namespace }}.svc.cluster.local:27017 \
                    --username "${MONGODB_USERNAME}" \
                    --password "${MONGODB_PASSWORD}" \
                    --authenticationDatabase admin \
                    --eval "sh.shardCollection('{{ $.Values.mongodb.setup.database }}.{{ .collectionName }}', { {{- range $i, $key := .shardKeys }}{{- if $i }}, {{ end }}'{{ $key.name }}': {{ if eq ($key.method | toString) "hashed" }}'hashed'{{ else }}{{ $key.method }}{{ end }}{{- end }} }, { unique: {{ .unique }} })" || true
            {{- end }}
            
            echo "Sharding setup completed successfully!"
        env:
          - name: MONGODB_USERNAME
            valueFrom:
              secretKeyRef:
                name: mongodb-users
                key: MONGODB_CLUSTER_ADMIN_USER
          - name: MONGODB_PASSWORD
            valueFrom:
              secretKeyRef:
                name: mongodb-users
                key: MONGODB_CLUSTER_ADMIN_PASSWORD
---
{{- end }}
{{- end }}
