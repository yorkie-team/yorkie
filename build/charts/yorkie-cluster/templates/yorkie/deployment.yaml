apiVersion: apps/v1
kind: Deployment
metadata:
  name: {{ .Values.yorkie.name }}
  namespace: {{ .Values.yorkie.namespace }}
  labels:
    app: {{ .Values.yorkie.name }}
    app.kubernetes.io/name: {{ .Values.yorkie.name }}
    app.kubernetes.io/instance: {{ .Values.yorkie.name }}
    app.kubernetes.io/version: {{ .Values.yorkie.image.tag | default .Chart.AppVersion }}
    app.kubernetes.io/component: server
    app.kubernetes.io/part-of: {{ .Values.yorkie.name }}
    app.kubernetes.io/managed-by: istio
    version: {{ .Values.yorkie.image.tag | default .Chart.AppVersion }}
spec:
  {{ if not .Values.yorkie.autoscaling.enabled }}
  replicas: {{ .Values.yorkie.autoscaling.replicaCount }}
  {{ end }}
  revisionHistoryLimit: 3
  selector:
    matchLabels:
      app.kubernetes.io/instance: {{ .Values.yorkie.name }}
  template:
    metadata:
      labels:
        app: {{ .Values.yorkie.name }}
        app.kubernetes.io/instance: {{ .Values.yorkie.name }}
        app.kubernetes.io/version: {{ .Values.yorkie.image.tag | default .Chart.AppVersion }}
        version: {{ .Values.yorkie.image.tag | default .Chart.AppVersion }}
      annotations:
        prometheus.io/scrape: "true"
        prometheus.io/port: "{{ .Values.yorkie.ports.profilingPort }}"
        prometheus.io/path: "/metrics"
    spec:
      {{ if index .Values "mongodb" "enabled"}}
      initContainers:
      - name: wait-for-mongodb-ready
        image: bitnami/kubectl:latest
        command:
          - /bin/sh
          - -c
          - |
            echo "Waiting for MongoDB to be ready..."
            while true; do
              # Check if PerconaServerMongoDB resource is ready
              status=$(kubectl get psmdb -n $NAMESPACE {{ index .Values "yorkie-mongodb" "fullnameOverride" }} -o jsonpath='{.status.state}' 2>/dev/null || echo "NotFound")
              if [ "$status" = "ready" ]; then
                echo "MongoDB cluster is ready!"
                break
              fi
              echo "Current status: $status. Waiting..."
              sleep 10
            done
        env:
          - name: NAMESPACE
            value: "{{ .Values.yorkie.namespace }}"
      serviceAccountName: yorkie-db-provisioning-job-account
      {{ end }}
      containers:
      - name: yorkie
        image: "{{ .Values.yorkie.image.repository }}:{{ .Values.yorkie.image.tag | default .Chart.AppVersion }}"
        imagePullPolicy: {{ .Values.yorkie.image.pullPolicy }}
        env:
          - name: POD_IP
            valueFrom:
              fieldRef:
                fieldPath: status.podIP
        args: [
          "server",
          "--mongo-connection-uri",
          {{- if .Values.yorkie.args.dbConnectionUri }}
          "{{ .Values.yorkie.args.dbConnectionUri }}",
          {{- else }}
          "mongodb://{{ .Values.mongodb.credentials.databaseAdmin.username }}:{{ .Values.mongodb.credentials.databaseAdmin.password }}@{{ index .Values "yorkie-mongodb" "fullnameOverride" }}-mongos.{{ .Values.yorkie.namespace }}.svc.cluster.local:27017/{{ .Values.yorkie.args.dbName }}?authSource=admin",
          {{- end }}
          "--mongo-yorkie-database",
          "{{ .Values.yorkie.args.dbName }}",
          "--pprof-enabled",
          "--rpc-port",
          "{{ .Values.yorkie.ports.rpcPort }}",
          "--profiling-port",
          "{{ .Values.yorkie.ports.profilingPort }}",
          "--backend-gateway-addr",
          "{{ .Values.yorkie.name }}-gateway.{{ .Values.yorkie.namespace }}.svc.cluster.local",
          "--backend-rpc-addr",
          "$(POD_IP):{{ .Values.yorkie.ports.rpcPort }}",
          "--backend-use-default-project", "{{ .Values.yorkie.args.useDefaultProject }}",
          {{- if .Values.yorkie.logLevel }}
          "--log-level",
          "{{ .Values.yorkie.logLevel }}",
          {{- end }}
          {{- if .Values.yorkie.mongoMonitoringEnabled }}
          "--mongo-monitoring-enabled",
          {{- if .Values.yorkie.mongoMonitoringSlowQueryThreshold }}
          "--mongo-monitoring-slow-query-threshold",
          "{{ .Values.yorkie.mongoMonitoringSlowQueryThreshold }}",
          {{- end }}
          {{- end }}
          {{- if .Values.yorkie.args.kafkaAddresses }}
          "--kafka-addresses",
          "{{ .Values.yorkie.args.kafkaAddresses }}",
          {{- end }}
          {{- if .Values.yorkie.args.kafkaUserEventsTopic }}
          "--kafka-user-events-topic",
          "{{ .Values.yorkie.args.kafkaUserEventsTopic }}",
          {{- end }}
          {{- if .Values.yorkie.args.kafkaChannelEventsTopic }}
          "--kafka-channel-events-topic",
          "{{ .Values.yorkie.args.kafkaChannelEventsTopic }}",
          {{- end }}
          {{- if .Values.yorkie.args.kafkaSessionEventsTopic }}
          "--kafka-session-events-topic",
          "{{ .Values.yorkie.args.kafkaSessionEventsTopic }}",
          {{- end }}
          {{- if .Values.yorkie.args.kafkaWriteTimeout }}
          "--kafka-write-timeout",
          "{{ .Values.yorkie.args.kafkaWriteTimeout }}",
          {{- end }}
          {{- if .Values.yorkie.args.githubClientID }}
          "--auth-github-client-id",
          "{{ .Values.yorkie.args.githubClientID }}",
          {{- end }}
          {{- if .Values.yorkie.args.githubClientSecret }}
          "--auth-github-client-secret",
          "{{ .Values.yorkie.args.githubClientSecret }}",
          {{- end }}
          {{- if .Values.yorkie.args.githubRedirectURL }}
          "--auth-github-redirect-url",
          "{{ .Values.yorkie.args.githubRedirectURL }}",
          {{- end }}
          {{- if .Values.yorkie.args.githubCallbackRedirectURL }}
          "--auth-github-callback-redirect-url",
          "{{ .Values.yorkie.args.githubCallbackRedirectURL }}",
          {{- end }}
          {{- if .Values.yorkie.args.githubAuthURL }}
          "--auth-github-auth-url",
          "{{ .Values.yorkie.args.githubAuthURL }}",
          {{- end }}
          {{- if .Values.yorkie.args.githubTokenURL }}
          "--auth-github-token-url",
          "{{ .Values.yorkie.args.githubTokenURL }}",
          {{- end }}
          {{- if .Values.yorkie.args.githubDeviceAuthURL }}
          "--auth-github-device-auth-url",
          "{{ .Values.yorkie.args.githubDeviceAuthURL }}",
          {{- end }}
          {{- if .Values.yorkie.args.githubUserURL }}
          "--auth-github-user-url",
          "{{ .Values.yorkie.args.githubUserURL }}",
          {{- end }}
          {{- if .Values.yorkie.args.starrocksDSN }}
          "--starrocks-dsn",
          "{{ .Values.yorkie.args.starrocksDSN }}",
          {{- end }}
        ]
        ports:
          - containerPort: {{ .Values.yorkie.ports.rpcPort }}
          - containerPort: {{ .Values.yorkie.ports.profilingPort }}
        livenessProbe:
          grpc:
            port: {{ .Values.yorkie.ports.rpcPort }}
          initialDelaySeconds: 10
        resources:
          {{ toYaml .Values.yorkie.resources | nindent 12 }}
