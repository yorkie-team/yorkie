# Configuration for Yorkie cluster
yorkie:
  name: yorkie
  namespace: yorkie

  autoscaling:
    enabled: false
    replicaCount: 3

  image:
    repository: yorkieteam/yorkie
    pullPolicy: IfNotPresent

  args:
    useDefaultProject: false
    # Percona MongoDB uses mongos service for sharded cluster
    # Connection URI will be generated from mongodb.credentials.databaseAdmin values
    dbConnectionUri: ""
    dbName: yorkie-meta

  ports:
    rpcPort: 8080
    profilingPort: 8081

  logLevel: "info"
  mongoMonitoringEnabled: false
  mongoMonitoringSlowQueryThreshold: "100ms"

  resources: {}

# Configuration for istio ingress gateway
ingressGateway:
  consistentHash:
    hashParameter: "x-shard-key"

    # Choose one of two hash based load balancing algorithms below
    # only one algorithm should be enalbed
    maglev:
      enabled: true
      tableSize: 65537

    ringHash:
      enabled: false
      minimumRingSize: 1024

  # Connection idle timeout for WatchDocument API
  httpConnection:
    streamIdleTimeout: 60s

  resources: {}

# Configuration for ingress (eg: AWS ALB)
ingress:
  ingressClassName: nginx
  ## Set to alb if you are using AWS, NCP ALB
  # ingressClassName: alb

  hosts:
    enabled: false
    apiHost: api.yorkie.dev

  awsAlb:
    enabled: false
    certArn: arn:aws:acm:ap-northeast-2:123412341234:certificate/1234-1234-1234-1234-1234

  ncpAlb:
    enabled: false
    certNo: 1234

  nginx:
    enabled: false

# Configuration for ratelimit
ratelimit:
  enabled: false
  name: ratelimit
  unit: minute
  requestsPerUnit: 10000
  domain: yorkie-ratelimit

# Configuration for MongoDB (Percona Operator)
mongodb:
  # Enable/disable MongoDB deployment
  enabled: false

  # MongoDB user credentials
  credentials:
    # Database admin user (used by Yorkie application)
    databaseAdmin:
      username: admin
      # Default password - CHANGE THIS for production!
      password: "admin"
    # User admin (used for user management)
    userAdmin:
      username: useradmin
      # Default password - CHANGE THIS for production!
      password: "useradmin"
    # Cluster admin user (used for sharding setup)
    clusterAdmin:
      username: clusteradmin
      # Default password - CHANGE THIS for production!
      password: "clusteradmin"

  # Configuration for sharding setup
  setup:
    enabled: true
    database: yorkie-meta
    restartPolicy: OnFailure
    backoffLimit: 5
    rules:
      - collectionName: clients
        shardKeys:
          - name: project_id
            method: 1
          - name: _id
            method: hashed
        unique: false
      - collectionName: documents
        shardKeys:
          - name: project_id
            method: 1
        unique: false
      - collectionName: schemas
        shardKeys:
          - name: project_id
            method: 1
        unique: false
      - collectionName: changes
        shardKeys:
          - name: doc_id
            method: hashed
        unique: false
      - collectionName: snapshots
        shardKeys:
          - name: doc_id
            method: hashed
        unique: false
      - collectionName: versionvectors
        shardKeys:
          - name: doc_id
            method: hashed
        unique: false
      - collectionName: revisions
        shardKeys:
          - name: doc_id
            method: hashed
        unique: false

# Configuration for Percona MongoDB Database
yorkie-mongodb:
  fullnameOverride: mongodb
  finalizers:
    - percona.com/delete-psmdb-pods-in-order

  # Allow single-node replica sets for development/testing
  unsafeFlags:
    replsetSize: true
    tls: true

  # Disable TLS for development/testing
  tls:
    mode: disabled

  image:
    repository: percona/percona-server-mongodb
    tag: "8.0.12-4"

  imagePullPolicy: IfNotPresent

  # Secrets for MongoDB users
  secrets:
    users: mongodb-users

  # PMM (Percona Monitoring and Management) - optional
  pmm:
    enabled: false

  # Log collector (FluentBit) - optional
  logcollector:
    enabled: false

  # Backup configuration - optional
  backup:
    enabled: false

  # Sharding configuration
  sharding:
    enabled: true

    configrs:
      size: 1
      volumeSpec:
        persistentVolumeClaim:
          resources:
            requests:
              storage: 1Gi

    mongos:
      size: 1

  replsets:
    # Shard 1
    - name: rs0
      size: 1
      volumeSpec:
        persistentVolumeClaim:
          storageClassName: standard
          accessModes: ["ReadWriteOnce"]
          resources:
            requests:
              storage: 10Gi
    # Shard 2
    - name: rs1
      size: 1
      volumeSpec:
        persistentVolumeClaim:
          storageClassName: standard
          accessModes: ["ReadWriteOnce"]
          resources:
            requests:
              storage: 10Gi
